{% extends "base.html" %}

{% block title %}Canlı Takip - NilüferAKS{% endblock %}

{% block extra_css %}
<style>
/* Mobile-First Optimization */
@media (max-width: 991px) {
    /* Full-screen harita mobilde */
    .tracking-desktop-sidebar {
        display: none !important;
    }
    
    .tracking-map-container {
        position: fixed !important;
        top: var(--navbar-height) !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 80px !important;
        padding: 0 !important;
        margin: 0 !important;
        z-index: 1 !important;
    }
    
    .tracking-map-container .card {
        height: 100% !important;
        margin: 0 !important;
        border-radius: 0 !important;
        border: none !important;
    }
    
    .tracking-map-container #map {
        height: 100% !important;
    }
    
    /* Bottom Sheet */
    .mobile-bottom-sheet {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        background: linear-gradient(135deg, #0f1629 0%, #0a0f1a 100%) !important;
        border-top: 2px solid var(--nilüfer-primary) !important;
        border-radius: 20px 20px 0 0 !important;
        box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.6) !important;
        z-index: 1000 !important;
        transition: transform 0.3s ease !important;
        max-height: 70vh !important;
        overflow-y: auto !important;
    }
    
    .mobile-bottom-sheet.collapsed {
        transform: translateY(calc(100% - 80px)) !important;
    }
    
    .bottom-sheet-handle {
        width: 50px !important;
        height: 5px !important;
        background: rgba(255, 255, 255, 0.3) !important;
        border-radius: 10px !important;
        margin: 12px auto !important;
        cursor: pointer !important;
    }
    
    .bottom-sheet-content {
        padding: 0 1rem 2rem 1rem !important;
    }
    
    /* Floating Search */
    .mobile-search-float {
        position: fixed !important;
        top: calc(var(--navbar-height) + 15px) !important;
        left: 15px !important;
        right: 15px !important;
        z-index: 999 !important;
    }
    
    .mobile-search-float .card {
        background: rgba(15, 22, 41, 0.95) !important;
        backdrop-filter: blur(10px) !important;
        border: 1px solid rgba(16, 185, 129, 0.3) !important;
    }
    
    /* Compact stats */
    .mobile-stats-compact {
        display: flex !important;
        gap: 1rem !important;
        padding: 0.75rem !important;
    }
    
    .mobile-stats-compact .stat-box {
        flex: 1 !important;
        text-align: center !important;
        padding: 0.5rem !important;
        background: rgba(16, 185, 129, 0.1) !important;
        border-radius: 8px !important;
        border: 1px solid rgba(16, 185, 129, 0.2) !important;
    }
    
    .mobile-stats-compact .stat-box h4 {
        font-size: 1.25rem !important;
        margin: 0 !important;
        font-weight: 800 !important;
    }
    
    .mobile-stats-compact .stat-box small {
        font-size: 0.7rem !important;
        opacity: 0.8 !important;
    }
}

/* Desktop: Keep original layout */
@media (min-width: 992px) {
    .mobile-bottom-sheet,
    .mobile-search-float {
        display: none !important;
    }
}

/* Smooth animations */
.mobile-bottom-sheet {
    touch-action: pan-y !important;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Sol Kolon: Bilgiler (Desktop) -->
    <div class="col-lg-4 tracking-desktop-sidebar">
        <!-- Filo Durumu -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-truck me-2"></i>Filo Durumu
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <h3 class="text-success mb-0" id="aktif-arac">-</h3>
                        <small class="text-muted">Toplam Araç</small>
                    </div>
                    <div class="col-4">
                        <h3 class="text-warning mb-0" id="toplam-mahalle">-</h3>
                        <small class="text-muted">Mahalle</small>
                    </div>
                    <div class="col-4">
                        <h3 class="text-info mb-0" id="toplam-konteyner">-</h3>
                        <small class="text-muted">Konteyner</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mahalle Seçimi -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-geo me-2"></i>Mahallenizi Seçin
            </div>
            <div class="card-body">
                <select class="form-select mb-3" id="mahalle-select">
                    <option value="">Mahalle Ara...</option>
                    <!-- API'den doldurulacak -->
                </select>
                
                <div id="mahalle-durum">
                    <p class="text-muted small text-center">
                        <i class="bi bi-info-circle me-1"></i>
                        Mahalle seçin
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Günlük İstatistik -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-bar-chart me-2"></i>Genel Bilgi
            </div>
            <div class="card-body">
                <div class="mb-3 d-flex justify-content-between">
                    <span>Günlük Ort. Tonaj</span>
                    <span id="stat-toplanan">-</span>
                </div>
                <div class="mb-3 d-flex justify-content-between">
                    <span>Toplam Mahalle</span>
                    <span id="stat-ziyaret">-</span>
                </div>
                <div class="mb-3 d-flex justify-content-between">
                    <span>Toplam Konteyner</span>
                    <span id="stat-kalan">-</span>
                </div>
            </div>
        </div>
        
        <!-- Bilgi -->
        <div class="card bg-primary bg-opacity-10 border-primary">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="bi bi-info-circle text-info me-3" style="font-size: 1.5rem;"></i>
                    <div>
                        <strong>Nilüfer AKS</strong><br>
                        <span class="text-muted">Akıllı Atık Kontrol Sistemi</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sağ Kolon: Harita -->
    <div class="col-lg-8 tracking-map-container">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-geo-alt me-2"></i>Canlı Araç Takip</span>
                <div class="d-none d-lg-block">
                    <span class="badge bg-success"><i class="bi bi-circle-fill"></i> Hareket</span>
                    <span class="badge bg-warning"><i class="bi bi-circle-fill"></i> Toplama</span>
                    <span class="badge bg-danger"><i class="bi bi-circle-fill"></i> Depo</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="map" style="height: 650px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Mobile: Floating Search -->
<div class="mobile-search-float d-lg-none">
    <div class="card shadow">
        <div class="card-body p-3">
            <div class="input-group">
                <span class="input-group-text bg-dark border-0">
                    <i class="bi bi-search text-success"></i>
                </span>
                <input type="text" class="form-control bg-dark text-light border-0" 
                       id="mobile-mahalle-search" placeholder="Mahallenizi ara...">
            </div>
            <div id="mobile-search-result" class="mt-2 d-none">
                <small class="text-success">
                    <i class="bi bi-geo-alt-fill"></i> <span id="mobile-result-text"></span>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Mobile: Bottom Sheet -->
<div class="mobile-bottom-sheet collapsed d-lg-none" id="bottomSheet">
    <div class="bottom-sheet-handle" id="sheetHandle"></div>
    
    <div class="bottom-sheet-content">
        <!-- Compact Stats -->
        <div class="mobile-stats-compact mb-3">
            <div class="stat-box">
                <h4 class="text-success" id="mobile-aktif">-</h4>
                <small class="text-muted">Araç</small>
            </div>
            <div class="stat-box">
                <h4 class="text-warning" id="mobile-bekleyen">-</h4>
                <small class="text-muted">Mahalle</small>
            </div>
            <div class="stat-box">
                <h4 class="text-info" id="mobile-tamamlanan">-</h4>
                <small class="text-muted">Konteyner</small>
            </div>
        </div>
        
        <!-- Bilgi Kutusu -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>Nilüfer AKS
            </div>
            <div class="card-body p-3">
                <div class="text-center py-3">
                    <i class="bi bi-database text-muted" style="font-size: 2rem;"></i>
                    <p class="text-muted mb-0 mt-2">Gerçek zamanlı takip verisi bekleniyor...</p>
                </div>
            </div>
        </div>
        
        <!-- Mahalle Listesi -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-list-check me-2"></i>Mahalle Durumları
            </div>
            <div class="card-body p-2">
                <div class="list-group list-group-flush">
                    <div class="list-group-item bg-transparent text-center py-3">
                        <small class="text-muted"><i class="bi bi-hourglass-split me-1"></i>Veri yükleniyor...</small>
                    </div>
                    <div class="list-group-item bg-transparent text-center py-3">
                        <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Mahalle verisi API'den yüklenecek</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Günlük İlerleme -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up me-2"></i>Sistem Durumu
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Toplam Araç</span>
                    <strong class="text-success" id="ilerleme-arac">-</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Toplam Mahalle</span>
                    <strong class="text-info" id="ilerleme-mahalle">-</strong>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>Konteyner Sayısı</span>
                    <strong class="text-warning" id="ilerleme-konteyner">-</strong>
                </div>
                <div class="text-center">
                    <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Gerçek zamanlı veri bağlantısı hazırlanıyor</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const map = L.map('map').setView([40.22, 28.89], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    // Harita bilgi kutusu
    const infoBox = L.control({position: 'topright'});
    infoBox.onAdd = function() {
        const div = L.DomUtil.create('div', 'map-info-box');
        div.innerHTML = '<div style="background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px; color: white;"><i class="bi bi-geo-alt me-1"></i>Yükleniyor...</div>';
        return div;
    };
    infoBox.addTo(map);
    
    // Nilüfer ilçe sınırını yükle
    async function loadNiluferSinir() {
        try {
            const response = await fetch('/api/nilufer/sinir');
            const data = await response.json();
            
            // Nilüfer sınırı - çok açık siyah, %10 opacity
            L.polygon(data.polygon, {
                color: '#1a1a1a',
                weight: 2,
                fillColor: '#333333',
                fillOpacity: 0.08,
                dashArray: '5,5'
            }).addTo(map);
            
            // Info box güncelle
            document.querySelector('.map-info-box').innerHTML = `
                <div style="background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; color: white;">
                    <i class="bi bi-geo-alt me-1"></i><strong>Nilüfer İlçesi</strong>
                </div>
            `;
            
        } catch (error) {
            console.error('Nilüfer sınırı yüklenemedi:', error);
        }
    }
    
    // Dropdown'ı doldur (GERÇEK VERİ)
    async function loadMahallelerDropdown() {
        try {
            const response = await fetch('/api/mahalleler/liste');
            const data = await response.json();
            
            const select = document.getElementById('mahalle-select');
            if (select) {
                select.innerHTML = '<option value="">Mahalle seçin...</option>';
                
                data.mahalleler.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.id;
                    option.textContent = m.ad;
                    option.dataset.lat = m.lat;
                    option.dataset.lon = m.lon;
                    select.appendChild(option);
                });
            }
            
        } catch (error) {
            console.error('Mahalle listesi yüklenemedi:', error);
        }
    }
    
    // API'den verileri yükle
    async function loadTrackingData() {
        try {
            const response = await fetch('/api/dashboard');
            const data = await response.json();
            
            // İstatistikleri güncelle
            document.getElementById('aktif-arac').textContent = data.toplam_arac || '-';
            document.getElementById('toplam-mahalle').textContent = data.toplam_mahalle || '-';
            document.getElementById('toplam-konteyner').textContent = data.toplam_konteyner ? data.toplam_konteyner.toLocaleString('tr-TR') : '-';
            
            document.getElementById('stat-toplanan').textContent = data.gunluk_tonaj ? data.gunluk_tonaj + ' ton' : '-';
            document.getElementById('stat-ziyaret').textContent = data.toplam_mahalle || '-';
            document.getElementById('stat-kalan').textContent = data.toplam_konteyner ? data.toplam_konteyner.toLocaleString('tr-TR') : '-';
            
            // Mobil istatistikler
            const mobileAktif = document.getElementById('mobile-aktif');
            const mobileBekleyen = document.getElementById('mobile-bekleyen');
            const mobileTamamlanan = document.getElementById('mobile-tamamlanan');
            
            if (mobileAktif) mobileAktif.textContent = data.toplam_arac || '-';
            if (mobileBekleyen) mobileBekleyen.textContent = data.toplam_mahalle || '-';
            if (mobileTamamlanan) mobileTamamlanan.textContent = data.toplam_konteyner ? (data.toplam_konteyner / 1000).toFixed(1) + 'K' : '-';
            
            // Sidebar ilerleme istatistikleri
            const ilerArac = document.getElementById('ilerleme-arac');
            const ilerMahalle = document.getElementById('ilerleme-mahalle');
            const ilerKonteyner = document.getElementById('ilerleme-konteyner');
            
            if (ilerArac) ilerArac.textContent = data.toplam_arac || '-';
            if (ilerMahalle) ilerMahalle.textContent = data.toplam_mahalle || '-';
            if (ilerKonteyner) ilerKonteyner.textContent = data.toplam_konteyner ? data.toplam_konteyner.toLocaleString('tr-TR') : '-';
            
        } catch (error) {
            console.error('Veri yüklenemedi:', error);
        }
    }
    
    // Başlat
    loadTrackingData();
    loadNiluferSinir();
    loadMahallelerDropdown();
    
    // Desktop: Mahalle seçimi
    const mahalleSelect = document.getElementById('mahalle-select');
    if (mahalleSelect) {
        mahalleSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const mahalleAd = selectedOption.textContent;
            
            if (this.value) {
                document.getElementById('mahalle-durum').innerHTML = `
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between bg-transparent">
                            <span><i class="bi bi-geo-alt me-1"></i>Seçilen</span>
                            <strong class="text-primary">${mahalleAd}</strong>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('mahalle-durum').innerHTML = `
                    <p class="text-muted small text-center">
                        <i class="bi bi-info-circle me-1"></i>Mahalle seçin
                    </p>
                `;
            }
        });
    }
    
    // Mobile: Bottom Sheet Toggle
    const bottomSheet = document.getElementById('bottomSheet');
    const sheetHandle = document.getElementById('sheetHandle');
    
    if (bottomSheet && sheetHandle) {
        sheetHandle.addEventListener('click', function() {
            bottomSheet.classList.toggle('collapsed');
        });
        
        // Touch swipe support
        let startY = 0;
        let currentY = 0;
        
        sheetHandle.addEventListener('touchstart', function(e) {
            startY = e.touches[0].clientY;
        });
        
        sheetHandle.addEventListener('touchmove', function(e) {
            currentY = e.touches[0].clientY;
            const diff = currentY - startY;
            
            if (Math.abs(diff) > 50) {
                if (diff > 0) {
                    bottomSheet.classList.add('collapsed');
                } else {
                    bottomSheet.classList.remove('collapsed');
                }
                startY = currentY;
            }
        });
    }
    
    // Mobile: Search (basitleştirildi)
    const mobileSearch = document.getElementById('mobile-mahalle-search');
    const mobileResult = document.getElementById('mobile-search-result');
    const mobileResultText = document.getElementById('mobile-result-text');
    
    if (mobileSearch) {
        mobileSearch.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            
            if (query.length > 1) {
                mobileResultText.textContent = `Aranıyor: ${query}`;
                mobileResult.classList.remove('d-none');
            } else {
                mobileResult.classList.add('d-none');
            }
        });
    }
    
    // Resize harita mobilde
    function resizeMap() {
        setTimeout(() => {
            map.invalidateSize();
        }, 100);
    }
    
    window.addEventListener('resize', resizeMap);
    resizeMap();
</script>
{% endblock %}